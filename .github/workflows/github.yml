name: Update Commit Heatmap and Recent Commits

on:
  schedule:
    - cron: '0 0 * * *'  # every day at midnight UTC
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch contribution heatmap
        run: |
          curl -s -H "Authorization: bearer ${{ secrets.GITHUB_TOKEN }}" \
               -H "Content-Type: application/json" \
               -d '{"query": "query { user(login: \"${{ github.repository_owner }}\") { contributionsCollection { contributionCalendar { weeks { contributionDays { date contributionCount color } } } } } }"}' \
               https://api.github.com/graphql \
          | jq '.data.user.contributionsCollection.contributionCalendar.weeks | map(.contributionDays) | flatten' \
          > app/data/heatmap.json

      - name: Fetch recent commits from PushEvents
        run: |
          USERNAME="${{ github.repository_owner }}"
          COMMITS_FILE="app/data/commits.json"
          mkdir -p app/data

          # Fetch recent events (up to 100)
          EVENTS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                   "https://api.github.com/users/$USERNAME/events?per_page=100")

          # Extract repo + head SHA from PushEvents
          PUSHES=$(echo "$EVENTS" | jq -r '[.[] | select(.type=="PushEvent") | {repo: .repo.name, sha: .payload.head}]')

          # Create an empty temp file to collect all commits
          echo "[" > "$COMMITS_FILE"
          FIRST=true

          echo "$PUSHES" | jq -c '.[]' | while read -r ITEM; do
            REPO=$(echo "$ITEM" | jq -r '.repo')
            SHA=$(echo "$ITEM" | jq -r '.sha')

            if [ -n "$REPO" ] && [ -n "$SHA" ] && [ "$SHA" != "null" ]; then
              echo "Fetching commit $SHA from $REPO"
              COMMIT=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                            "https://api.github.com/repos/$REPO/commits/$SHA")

              # Append JSON safely (no giant jq pipes)
              if [ "$FIRST" = true ]; then
                echo "$COMMIT" >> "$COMMITS_FILE"
                FIRST=false
              else
                echo ",$COMMIT" >> "$COMMITS_FILE"
              fi
            fi
          done

          echo "]" >> "$COMMITS_FILE"

          # Deduplicate and sort by date descending
          cat "$COMMITS_FILE" | jq 'unique_by(.sha) | sort_by(.commit.author.date) | reverse' > tmp.json
          mv tmp.json "$COMMITS_FILE"

      - name: Commit and push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add app/data/heatmap.json app/data/commits.json
          git commit -m "Update heatmap and recent commits [skip ci]" || echo "No changes"
          git push
